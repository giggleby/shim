{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "description": "reference: http://goto/cros-factory-test-list, ./TEST_LIST.md, ./JSON_TEST_LIST.md",
  "definitions": {
    "eval_expression": {
      "type": "string",
      "pattern": "eval! .*",
      "description": "String prefix to indicate this value needs to be evaluated in runtime."
    },
    "eval_boolean": {
      "oneOf":[
        {
          "type": "boolean"
        },
        {
          "$ref": "#/definitions/eval_expression"
        }
      ]
    },
    "eval_integer": {
      "oneOf":[
        {
          "type": "integer"
        },
        {
          "$ref": "#/definitions/eval_expression"
        }
      ]
    },
    "eval_optional_integer": {
      "oneOf":[
        {
          "type": ["integer", "null"]
        },
        {
          "$ref": "#/definitions/eval_expression"
        }
      ]
    },
    "eval_array": {
      "oneOf":[
        {
          "type": "array"
        },
        {
          "$ref": "#/definitions/eval_expression"
        }
      ]
    },
    "eval_object": {
      "oneOf":[
        {
          "type": "object"
        },
        {
          "$ref": "#/definitions/eval_expression"
        }
      ]
    },
    "test_comment": {
      "description": "this field will be completely ignored by test list loader.",
      "type": "string"
    },
    "test_object": {
      "type": ["object", "string"],
      "properties": {
        "action_on_failure": {
          "type": "string",
          "enum": ["NEXT", "PARENT", "STOP"]
        },
        "args": {
          "type": "object"
        },
        "disable_abort": {
          "type": "boolean"
        },
        "disable_services": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "dut_options": {
          "type": "object"
        },
        "enable_services": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "exclusive_resources": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "id": {
          "type": "string"
        },
        "iterations": {
          "type": "number"
        },
        "label": {
          "type": ["string", "object"]
        },
        "layout": {
          "$ref": "#/definitions/test_ui_layout"
        },
        "locals": {
          "$ref": "#/definitions/test_constants"
        },
        "no_host": {
          "type": "boolean"
        },
        "allow_reboot": {
          "type": "boolean"
        },
        "parallel": {
          "type": "boolean"
        },
        "pytest_name": {
          "type": "string"
        },
        "retries": {
          "type": "number"
        },
        "run_if": {
          "type": "string"
        },
        "subtests": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/test_object"
          }
        },
        "teardown": {
          "type": "boolean"
        },
        "inherit": {
          "type": "string"
        },
        "child_action_on_failure": {
          "type": "string",
          "enum": ["NEXT", "PARENT", "STOP"]
        },
        "require_run": {
          "type": ["string", "array"],
          "items": {
            "type": "string"
          }
        }
      },
      "patternProperties": {
        "^__comment[A-Za-z0-9_-]*$": {
          "$ref": "#/definitions/test_comment"
        }
      },
      "dependencies": {
        "layout": {
          "properties": {
            "parallel": {
              "enum": [true]
            }
          },
          "required": ["parallel"]
        }
      },
      "additionalProperties": false
    },
    "test_allow_list": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "test_phase_allow_list": {
      "type": "object",
      "properties": {
        "PROTO" : {
          "$ref": "#/definitions/test_allow_list"
        },
        "EVT" : {
          "$ref": "#/definitions/test_allow_list"
        },
        "DVT" : {
          "$ref": "#/definitions/test_allow_list"
        },
        "PVT_DOGFOOD" : {
          "$ref": "#/definitions/test_allow_list"
        },
        "PVT" : {
          "$ref": "#/definitions/test_allow_list"
        }
      },
      "patternProperties": {
        "^__comment[A-Za-z0-9_-]*$": {
          "$ref": "#/definitions/test_comment"
        },
        "^[^_].*$": {
          "$ref": "#/definitions/test_allow_list"
        }
      },
      "additionalProperties": false
    },
    "test_options": {
      "__comment": "please see cros.factory.test.test_lists.test_list.Options",
      "type": "object",
      "properties": {
        "auto_run_on_start": {
          "$ref": "#/definitions/eval_boolean",
          "default": true
        },
        "retry_failed_on_start": {
          "$ref": "#/definitions/eval_boolean",
          "default": false
        },
        "clear_state_on_start": {
          "$ref": "#/definitions/eval_boolean",
          "default": false
        },
        "auto_run_on_keypress": {
          "$ref": "#/definitions/eval_boolean",
          "default": false
        },
        "ui_locale": {
          "type": "string",
          "default": "en-US"
        },
        "engineering_password_sha1": {
          "type": ["string", "null"]
        },
        "sync_event_log_period_secs": {
          "$ref": "#/definitions/eval_optional_integer"
        },
        "update_period_secs": {
          "$ref": "#/definitions/eval_optional_integer"
        },
        "stop_on_failure": {
          "$ref": "#/definitions/eval_boolean",
          "default": false
        },
        "hooks_class": {
          "type": "string",
          "default": "cros.factory.goofy.hooks.Hooks"
        },
        "testlog_hooks": {
          "type": "string",
          "default": "cros.factory.testlog.hooks.Hooks"
        },
        "phase": {
          "oneOf":[
            {
              "enum": ["PROTO", "EVT", "DVT", "PVT_DOGFOOD", "PVT", null]
            },
            {
              "$ref": "#/definitions/eval_expression"
            }
          ]
        },
        "dut_options": {
          "$ref": "#/definitions/eval_object"
        },
        "plugin_config_name": {
          "type": ["string", "null"],
          "default": "goofy_plugin_chromeos"
        },
        "read_device_data_from_vpd_on_init": {
          "$ref": "#/definitions/eval_boolean",
          "default": true
        },
        "skipped_tests": {
          "$ref": "#/definitions/test_phase_allow_list"
        },
        "waived_tests": {
          "$ref": "#/definitions/test_phase_allow_list"
        }
      },
      "patternProperties": {
        "^__comment[A-Za-z0-9_-]*$": {
          "$ref": "#/definitions/test_comment"
        }
      },
      "additionalProperties": false
    },
    "grt_allow_list": {
      "type": "array",
      "items": {
        "enum": [
          "clear_factory_vpd_entries",
          "clear_gbb_flags",
          "cr50_disable_factory_mode",
          "cr50_finalize",
          "cr50_set_ro_hash",
          "cr50_smt_write_flash_info",
          "cr50_write_flash_info",
          "enable_release_partition",
          "fpmcu_initialize_entropy",
          "generate_stable_device_secret",
          "log_source_hashes",
          "log_system_details",
          "set_fw_bitmap_locale",
          "untar_stateful_files",
          "upload_report",
          "verify_cbi_eeprom_wp_status",
          "verify_cros_config",
          "verify_dlc_images",
          "verify_ec_key",
          "verify_fp_key",
          "verify_hwid",
          "verify_keys",
          "verify_me_locked",
          "verify_release_channel",
          "verify_rlz_code",
          "verify_rootfs",
          "verify_switch_wp",
          "verify_system_time",
          "verify_tpm",
          "verify_vpd",
          "verify-sn-bits",
          "wipe_in_place",
          "write_protect"
        ]
      },
      "default": []
    },
    "test_constants": {
      "type": "object",
      "patternProperties": {
        "^__comment[A-Za-z0-9_-]*$": {
          "type": "string"
        },
        "^[A-Za-z0-9][A-Za-z0-9_-]*$": {
        }
      },
      "properties": {
        "grt": {
          "type": "object",
          "properties": {
            "force_write_protect": {
              "type": "boolean",
              "description": "*** Write protection is required for mass production and shippable devices. By default we enable write protection starting from PVT stages, but you can start trying write protection earlier by this option.",
              "default": false
            },
            "cbi_eeprom_wp_status": {
              "enum": ["Absent", "Locked", "Unlocked"],
              "description": "Set this to 'Absent' for board without CBI EEPROM. Set this to 'Unlocked' for MLB layouts which requires CBI WP being disabled in pre-PVT and enabled in PVT.",
              "default": "Locked"
            },
            "collect_zero_touch_ids": {
              "type": "boolean",
              "default": false
            },
            "ec_pubkey_path": {
              "type": ["string", "null"],
              "default": null
            },
            "ec_pubkey_hash": {
              "type": ["string", "null"],
              "default": null
            },
            "rma_mode": {
              "type": "boolean",
              "default": false
            },
            "mlb_mode": {
              "type": "boolean",
              "description": "The MLB will leave factory without assembly, for example, this is a RMA spare board or local OEM projects.",
              "default": false
            },
            "enable_zero_touch": {
              "type": "boolean",
              "default": false
            },
            "gooftool_skip_list": {
              "$ref": "#/definitions/grt_allow_list"
            },
            "gooftool_waive_list": {
              "$ref": "#/definitions/grt_allow_list"
            },
            "re_sign_release_kernel": {
              "type": "boolean",
              "description": "Enable this if you want to finalize with a DEV signed kernel; go/cros-factory-fw-in-early-builds",
              "default": false
            },
            "secure_wipe": {
              "type": "boolean",
              "default": true
            },
            "is_reference_board": {
              "type": "boolean",
              "default": false
            }
          },
          "patternProperties": {
            "^__comment[A-Za-z0-9_-]*$": {
              "$ref": "#/definitions/test_comment"
            }
          },
          "additionalProperties": false
        },
        "overlord": {
          "type": "object",
          "properties": {
            "overlord_urls": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "tls_no_verify": {
              "type": "boolean"
            }
          }
        }
      },
      "additionalProperties": false
    },
    "test_ui_layout_type": {
      "type": "string",
      "enum": ["tab", "tiled"]
    },
    "test_ui_layout": {
      "anyOf": [
        {
          "$ref": "#/definitions/test_ui_layout_type"
        },
        {
          "type": "object",
          "properties": {
            "type": {
              "$ref": "#/definitions/test_ui_layout_type"
            },
            "options": {
              "type": "object"
            }
          },
          "additionalProperties": false
        }
      ]
    }
  },
  "type": "object",
  "properties": {
    "label": {
      "type": "string"
    },
    "options": {
      "$ref": "#/definitions/test_options"
    },
    "constants": {
      "$ref": "#/definitions/test_constants"
    },
    "definitions": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/test_object"
      }
    },
    "tests": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/test_object"
      }
    },
    "override_args": {
      "__comment": "To override argument of a test in 'tests', maps the test path to a dictionary",
      "type": "object"
    }
  },
  "patternProperties": {
    "^__comment[A-Za-z0-9_-]*$": {
      "$ref": "#/definitions/test_comment"
    }
  },
  "required": [
    "options",
    "constants"
  ],
  "additionalProperties": false
}
