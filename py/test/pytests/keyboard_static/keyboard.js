// Copyright 2012 The ChromiumOS Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

window.KEY_CONFIG = {
  '1': {
    'default': {'text': 'esc', 'height':0.5}
  },
  '2': {
    'default': {'text': '1'}
  },
  '3': {
    'default': {'text': '2'}
  },
  '4': {
    'default': {'text': '3'}
  },
  '5': {
    'default': {'text': '4'}
  },
  '6': {
    'default': {'text': '5'}
  },
  '7': {
    'default': {'text': '6'}
  },
  '8': {
    'default': {'text': '7'}
  },
  '9': {
    'default': {'text': '8'}
  },
  '10': {
    'default': {'text': '9'}
  },
  '11': {
    'default': {'text': '0'}
  },
  '12': {
    'default': {'text': '-'}
  },
  '13': {
    'default': {'text': '='},
    'JIS': {'text': '^'},
  },
  '14': {
    'default': {'text': '‚¨Ö', 'width':1.5},
    'JIS': {'width':1}
  },
  '15': {
    'default': {'text': '‚û°', 'width':1.5}
  },
  '16': {
    'default': {'text': 'q'}
  },
  '17': {
    'default': {'text': 'w'}
  },
  '18': {
    'default': {'text': 'e'}
  },
  '19': {
    'default': {'text': 'r'}
  },
  '20': {
    'default': {'text': 't'}
  },
  '21': {
    'default': {'text': 'y'}
  },
  '22': {
    'default': {'text': 'u'}
  },
  '23': {
    'default': {'text': 'i'}
  },
  '24': {
    'default': {'text': 'o'}
  },
  '25': {
    'default': {'text': 'p'}
  },
  '26': {
    'default': {'text': '['},
    'JIS': {'text': '@'},
  },
  '27': {
    'default': {'text': ']'},
    'JIS': {'text': '['},
  },
  '28': {
    'default': {'text': 'enter', 'width':1.85},
    'ISO': {'width':0.75, 'height': 2.1, 'left': 0.25},
    'JIS': {'width':1.25, 'height': 2.1, 'left': 0.25}
  },
  '29': {
    'default': {'text': 'ctrl', 'width':2},
    'JIS': {'width':1.5}
  },
  '30': {
    'default': {'text': 'a'}
  },
  '31': {
    'default': {'text': 's'}
  },
  '32': {
    'default': {'text': 'd'}
  },
  '33': {
    'default': {'text': 'f'}
  },
  '34': {
    'default': {'text': 'g'}
  },
  '35': {
    'default': {'text': 'h'}
  },
  '36': {
    'default': {'text': 'j'}
  },
  '37': {
    'default': {'text': 'k'}
  },
  '38': {
    'default': {'text': 'l'}
  },
  '39': {
    'default': {'text': ';'},
  },
  '40': {
    'default': {'text': '\''},
    'JIS': {'text': ':'},
  },
  '41': {
    'default': {'text': '`'},
    'JIS': {'text': '‚Üï'},
  },
  '42': {
    'default': {'text': 'shift', 'width':2.35},
    'ISO': {'width': 1.35}
  },
  '43': {
    'default': {'text': '\\'},
    'ISO': {'text': '#'},
    'JIS': {'text': ']'},
  },
  '44': {
    'default': {'text': 'z'}
  },
  '45': {
    'default': {'text': 'x'}
  },
  '46': {
    'default': {'text': 'c'}
  },
  '47': {
    'default': {'text': 'v'}
  },
  '48': {
    'default': {'text': 'b'}
  },
  '49': {
    'default': {'text': 'n'}
  },
  '50': {
    'default': {'text': 'm'}
  },
  '51': {
    'default': {'text': ','}
  },
  '52': {
    'default': {'text': '.'}
  },
  '53': {
    'default': {'text': '/'}
  },
  '54': {
    'default': {'text': 'shift', 'width': 2.35},
    'JIS': {'width':1.75}
  },
  '55': {
    'default': {'text': '*'}
  },
  '56': {
    'default': {'text': 'alt', 'width':2},
    'JIS': {'width':1.5}
  },
  '57': {
    'default': {'text': 'space', 'width':6.2},
    'JIS': {'width':5}
  },
  '71': {
    'default': {'text': '7'}
  },
  '72': {
    'default': {'text': '8'}
  },
  '73': {
    'default': {'text': '9'}
  },
  '74': {
    'default': {'text': '-'}
  },
  '75': {
    'default': {'text': '4'}
  },
  '76': {
    'default': {'text': '5'}
  },
  '77': {
    'default': {'text': '6'}
  },
  '78': {
    'default': {'text': '+', 'height':2.1}
  },
  '79': {
    'default': {'text': '1'}
  },
  '80': {
    'default': {'text': '2'}
  },
  '81': {
    'default': {'text': '3'}
  },
  '82': {
    'default': {'text': '0', 'width':2.1}
  },
  '83': {
    'default': {'text': '.'}
  },
  '86': {
    'default': {'text': '\\'}
  },
  '89': {
    'default': {'text': '\\'},
  },
  '92': {
    'default': {'width': 1.25}
  },
  '94': {
    'default': {'width': 1.25}
  },
  '96': {
    'default': {'text': 'enter', 'height':2.1}
  },
  '97': {
    'default': {'text': 'ctrl'}
  },
  '98': {
    'default': {'text': '/'}
  },
  '100': {
    'default': {'text': 'alt'}
  },
  '102': {
    'default': {'text': 'home', 'height':0.5, 'font-size': '11px'}
  },
  '103': {
    'default': {'text': '‚¨Ü', 'height':0.45}
  },
  '104': {
    'default': {'text': 'page up', 'height':0.5, 'font-size': '11px'}
  },
  '105': {
    'default': {'text': '‚¨Ö', 'height':0.45, 'top':0.55}
  },
  '106': {
    'default': {'text': '‚û°', 'height':0.45, 'top':0.55}
  },
  '107': {
    'default': {'text': 'end', 'height':0.5, 'font-size': '11px'}
  },
  '108': {
    'default': {'text': '‚¨á', 'height':0.45, 'left':1.1}
  },
  '109': {
    'default': {'text': 'page dn', 'height':0.5, 'font-size': '11px'}
  },
  '111': {
    'default': {'text': 'delete'}
  },
  '116': {
    'default': {'text': '‚èª', 'height':0.5}
  },
  '124': {
    'default': {'text': '¬•'}
  },
  '125': {
    'default': {'text': 'üîç', 'width':1.75}
  },
  '142': {
    'default': {'text': 'üîí'}
  }
};

window.KeyboardTest = class {
  BASE_BUTTON_SIZE = 50;
  MARGIN = this.BASE_BUTTON_SIZE * 0.1;

  constructor(layout, fnKeycodes, keycodes, numpadKeycodes) {
    window.layout = layout
    let width = 805;
    if (layout === 'JIS') {
      width = 850;
    }
    document.getElementById('keyboard').style.width = width + 'px';
    this.setFnRow(fnKeycodes, width);
    for (let i=0; i<keycodes.length; i++) {
      const row = document.getElementById('row' + i)
        .getElementsByClassName('button-wrapper')[0];
      for (let j=0; j<keycodes[i].length; j++) {
        const keycode = keycodes[i][j];
        row.appendChild(this.createButtonByConfig(keycode));
      }
    }

    if (numpadKeycodes.length > 0) {
      for (let i=0; i<numpadKeycodes.length; i++) {
        const row = document.getElementById('numpad' + i)
          .getElementsByClassName('button-wrapper')[0];
        for (let j=0; j<numpadKeycodes[i].length; j++) {
          const keycode = numpadKeycodes[i][j];
          row.appendChild(this.createButtonByConfig(keycode));
        }
      }
      document.getElementById('numpad').style.display = 'block';
    }

    window.adjustSize();
  }

  createButton = function(keycode, text, width, height, left, top, fontSize) {
    const button = document.createElement('div');
    button.id = keycode;
    button.className += 'button button-margin';
    if (height < 1) {
      button.className += ' button-sm';
    }
    button.style['line-height'] = height * this.BASE_BUTTON_SIZE + 'px';
    button.style.height = height * this.BASE_BUTTON_SIZE + 'px';
    button.style.width = width * this.BASE_BUTTON_SIZE + 'px';
    button.style.left = left * this.BASE_BUTTON_SIZE + 'px';
    button.style.top = top * this.BASE_BUTTON_SIZE + 'px';
    button.style['font-size'] = fontSize;

    const displayText = document.createElement('span');
    displayText.innerText = text;
    button.appendChild(displayText);
    const status = document.createElement('div');
    status.id = keycode + '_status';
    status.className = 'key-status';
    button.appendChild(status);
    return button;
  };

  createButtonByConfig = function(keycode) {
    const config = window.KEY_CONFIG[keycode];
    const layout = window.layout;
    const getFieldInConfig = function(fieldName) {
      return (config[layout] && config[layout][fieldName])
      || (config['default'] && config['default'][fieldName])
    }
    const text = getFieldInConfig('text') || '';
    const width = getFieldInConfig('width') || 1;
    const height = getFieldInConfig('height') || 1;
    const left = getFieldInConfig('left') || '';
    const top = getFieldInConfig('top') || '';
    const size = getFieldInConfig('font-size') || '';
    return this.createButton(keycode, text, width, height, left, top, size);
  }

  hold = function(keycode, remainCount) {
    const status = document.getElementById(keycode + '_status');
    if (remainCount > 0) {
      remainCount -= 1;
    }
    status.innerText = remainCount;
    status.style.display = 'block';
    this.setColor(keycode, 'yellow')
  }

  click = function(keycode, remainCount) {
    if (remainCount == 0) {
      this.setColor(keycode, 'green')
    }
    else {
      this.setColor(keycode, '')
    }
    const status = document.getElementById(keycode + '_status');
    status.style.display = '';
  }

  skip = keycode => this.setColor(keycode, 'gray');

  hint = function(keycodes, reset=false) {
    if (reset) {
      const buttons = document.getElementsByClassName('button');
      for (let i=0; i<buttons.length; i++) {
        buttons[i].style['background-color'] = '';
      }
    }
    for (let i=0; i<keycodes.length; i++) {
      this.setColor(keycodes[i], 'deepskyblue');
      const status = document.getElementById(keycodes[i] + '_status');
      status.style.display = '';
    }
  }

  setColor = function(keycode, color) {
    const button = document.getElementById(keycode);
    button.style['background-color'] = color;
  }

  setFnRow = function(keycodes, totalWidth) {
    const row = document.getElementById('fn-row')
      .getElementsByClassName('button-wrapper')[0];
    const keyCount = keycodes.length;
    const width = (totalWidth - (keyCount+1) * this.MARGIN) / keyCount
      / this.BASE_BUTTON_SIZE;
    for (let i=0; i<keycodes.length; i++) {
      const config = window.KEY_CONFIG[keycodes[i]];
      const text = (config && config['default'] && config['default']['text'])
        || '';
      row.appendChild(this.createButton(keycodes[i], text, width, 0.5));
    }
  }
}

window.displayKeyCode = function() {
  /*
    This function will do nothing before initializing the KeyboardTest class.
    The caller of this function is the button in keyboard.html, and I can't
    get the instant of the the class, so it's defined as a global function
    but not a member function of the class.
  */
  buttons = document.getElementsByClassName('button');
  for (let i=0; i<buttons.length; i++) {
    buttons[i].childNodes[0].textContent = buttons[i].id;
  }
}

window.displayText = function() {
  /*
    This function will do nothing before initializing the KeyboardTest class.
    The caller of this function is the button in keyboard.html, and I can't
    get the instant of the the class, so it's defined as a global function
    but not a member function of the class.
  */
  buttons = document.getElementsByClassName('button');
  const layout = window.layout;
  for (let i=0; i<buttons.length; i++) {
    const config = window.KEY_CONFIG[buttons[i].id];
    const textNode = buttons[i].childNodes[0];
    if (config) {
      textNode.textContent = (config[layout] && config[layout]['text'])
      || (config['default'] && config['default']['text']);
    } else {
      textNode.textContent = '';
    }
  }
}

window.adjustSize = function() {
  // This function scales the displayed keyboard for large screen.
  const div = document.getElementById('keyboard').parentNode;
  const scale = Math.min(window.innerWidth / 1200, window.innerHeight / 600);
  div.style['transform'] = `scale(${scale.toFixed(2)})`;
}

window.onresize = window.adjustSize;